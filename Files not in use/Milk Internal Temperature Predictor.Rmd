---
Author: 
title: "Time and Temperature profile generator"
output: html_document
date: '2022-07-25'
---

#Milk Temperature Curves Validation

```{r}
#loading libraries
library(reshape2)
library(ggplot2)
```

This chunk creates the heat transfer coefficients from the negative slopes obtained in the excel file. 
```{r}
#Standard Inputs
rho <-1.033 #kg/L
C <- 4.2 #kj/KgC°
V <- 0.236 #L
A <- 0.004275 #m2


get_h<-function(Neg_slope, rho = 1.033, C = 4.2 , V = 0.236, A = 0.004275){
  neg_h = ((Neg_slope*rho*C*V)/A)
  return(-neg_h)
} 

#Negative Slopes
Neg_Slope_RTB<-(-0.01293) #Room Temperature
Neg_Slope_Ref<-(-0.01620) #Refrigeration
Neg_Slope_RT<-(-0.01183) #Refrigerated Tray
Neg_Slope_TIC<-(-0.006528) #Tray with Ice 
Neg_Slope_TIP<-(-0.006007) #Tray with Ice Packs
Neg_Slope_CI<-(-0.002103) #Cooler with Ice

#Getting the Heat Transfer Coefficients for each Temp
h_RTB = get_h(Neg_slope = Neg_Slope_RTB)
h_ref = get_h(Neg_slope = Neg_Slope_Ref)
h_RT = get_h(Neg_slope = Neg_Slope_RT)
h_TIC = get_h(Neg_slope = Neg_Slope_TIC)
h_TIP = get_h(Neg_slope = Neg_Slope_TIP)
h_CI = get_h(Neg_slope = Neg_Slope_CI)


#Function to get temperature as a constant time and temperature
get_temp<-function(h, To, Tinf, time,  A =0.004275,rho =1.033, C= 4.2, V = 0.236 ){
  #Time in minutes
  #Tinf = External Temp
  #To = Initial temperature of the milk
  # h = convection trans coefficient for that condition
  #time = time in minutes (because negative slope is per min)
  return (exp(-(h*A/rho*C*V)*(time))*(To-Tinf)+Tinf)
}
```

##Function to create time and temp profiles vector
The function below creates a time and temperature profile (internal milk temperature) given a constant external , the initial temperature of the milk, the total time, and the heat transfer coefficient
```{r}
#Constant outside temperature
  #Initial temp = the temp of the milk when entering that condition
  #Room Temp = constant temperature of the room
  #Total min: the length that the milk is at that room temperature
  #h_condition = the heat trasnfer coefficient of that condition
predict_temp<-function(Initial_Temp, Room_temp, Total_min, h_condition){
  
  #Constant outside temperature
  #Initial temp = the temp of the milk when entering that condition
  #Room Temp = constant temperature of the room
  #Total min: the length that the milk is at that room temperature
  #h_condition = the heat transfer coefficient of that condition
  
  #Returns a vector of temperatures
  #redifining terms is redundant but helps keep track
  Total_Time_min = Total_min
  Temp_Initial = Initial_Temp
  T_inf = Room_temp
  Temp_V<-c()
  for (i in 1:Total_Time_min){
    if (i == 1){
      New_Temp = Temp_Initial
    }else if (i == 2){
      New_Temp = get_temp(h = h_condition, To = Temp_Initial, Tinf =  T_inf, time = 1)
    }else{
      New_Temp = get_temp(h = h_condition, To = New_Temp, Tinf =  T_inf, time = 1)
    }
    Temp_V<-c(Temp_V, New_Temp)
  }
  return (Temp_V)
  #returns a vector of internal temperatures in 1 minute intervals. 
}


#Example of how this could work.
predict_temp(Initial_Temp = 4.5,Room_temp = 22, Total_min = 42, h_condition = h_RTB)

```


#Predicting the milk internal temperature from a time and temperature profile
The external temperature will not always be constants. In many instances the temperature may vary by a couple degrees. this equation is able to do that

```{r}
#Predicting the temperature from a complete time and temperature profile.
predict_temp_fromProf<-function(Time_Temp_Prof, Initial_Temp,h_condition){
  #Time_Temp_Prof = a vector of temperatures in 1 minute intervals
  #initial temp = the initial temperature of the milk
  #h_condition = the h condition
  Time_Temp_Profile<-Time_Temp_Prof
  Temp_Initial = Initial_Temp
  Temp_V<-c()
  for (i in 1:length(Time_Temp_Profile)){
    T_inf<-Time_Temp_Profile[i]
    if (i == 1){
      New_Temp = Temp_Initial
    }else if (i == 2){
      New_Temp = get_temp(h = h_condition, To = Temp_Initial, Tinf =  T_inf, time = 1)
    }else{
      New_Temp = get_temp(h = h_condition, To = New_Temp, Tinf =  T_inf, time = 1)
    }
    Temp_V<-c(Temp_V, New_Temp)
  }
  return(Temp_V)
}


#This function creates a room temperature where the temperature varies based on a mean and a standard deviation. The output is a vector of temperatures that could be an input to the function defined earlier in this chunk. 
Time_Temp_Creation_Var<-function(Total_Time, Interval, Mean_Temperature, SD_Temperature){
  Time_Temp_df<-data.frame("min"= seq(0,Total_Time,by = Interval),
                         "tempM"= rnorm(n =Total_Time+1, mean = Mean_Temperature, sd= SD_Temperature))
  return (Time_Temp_df)
}

```

#Functions to calculate the RMSE
```{r}

calc_rmse=function(actual, predicted) {
  sqrt(mean((actual - predicted) ^ 2))
}

calc_bias = function(actual,predicted){
  mean(predicted - actual)
}
```


#Testing Data-Using the functions to calculate the internal milk temperature for the bevier trials. 
- Testing data. 
```{r}
Condition_Data<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep4Data.csv")
Condition_Data_InternalMilk<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep4Data.csv")

Predicted_RTB<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk$Refrigeration[1], h_condition = h_ref)


calc_rmse(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])

calc_bias(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])


PredictionDf<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB,
                         "Cooler.with.Ice" = Predicted_CI,
                         "Tray.with.Ice"= Predicted_TI,
                         "Tray.with.Ice.Packs"= Predicted_TIP,
                         "Refrigerated.Tray" = Predicted_RT,
                         "Refrigeration" = Predicted_ref)


Internal_DF<-reshape2::melt(Condition_Data_InternalMilk, id.vars = "Time")
Internal_DF$type<-"Observed"

Predicted_DF<-reshape2::melt(PredictionDf, id.vars = "Time")
Predicted_DF$type<-"Predicted"

Predicted_vs_Observed<-rbind(Internal_DF,Predicted_DF)

Predicted_vs_Observed$variable<-as.character(Predicted_vs_Observed$variable)

Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Ambient.Temperature"] <- "Ambient Temperature"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice"] <- "Tray with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"


#RMSE and Text
dat_text <- data.frame(
label = c("RMSE: 0.50", "RMSE: 0.58", "RMSE:0.63", "RMSE: 0.20", "RMSE: 0.27", "RMSE: 0.48"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,12.5),
  y     = c(5, 2.5, 3.6,3.9,5.1,13)
)

dat_text_h <- data.frame(
label = c("Bias: 0.49", "Bias: -0.56", "Bias: 0.49", "Bias: 0.18", "Bias: 0.24", "Bias = -0.47"  ),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40, 12.5),
  y     = c(3.5, 2.1, 2.7,3,3.8, 11.5)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_h$variable<-factor(dat_text_h$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

Predicted_vs_Observed$variable<-factor(Predicted_vs_Observed$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

ggplot(Predicted_vs_Observed, aes(x = Time))+
  #geom_point(aes(y = value, color = type))+
  geom_line(aes(y = value, color = type, linetype = type), size=1)+
  facet_wrap(~variable,scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = "Observed vs Predicted",linetype = "Observed vs Predicted", title = "Testing Data")+
  geom_text(data    = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
    geom_text(data    = dat_text_h,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#00AFBB", "#FC4E07")) +
  theme(legend.position="bottom")

ggsave("Figures/Testing Set Plot.jpg", width =8, height = 5, units = "in", dpi = 300)

```

##Testing data plus overall h
```{r}
Condition_Data<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep4Data.csv")
Condition_Data_InternalMilk<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep4Data.csv")

Predicted_RTB<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk$Refrigeration[1], h_condition = h_ref)


calc_rmse(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])

calc_bias(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])


PredictionDf<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB,
                         "Cooler.with.Ice" = Predicted_CI,
                         "Tray.with.Ice"= Predicted_TI,
                         "Tray.with.Ice.Packs"= Predicted_TIP,
                         "Refrigerated.Tray" = Predicted_RT,
                         "Refrigeration" = Predicted_ref)


Internal_DF<-reshape2::melt(Condition_Data_InternalMilk, id.vars = "Time")
Internal_DF$type<-"Observed"

Predicted_DF<-reshape2::melt(PredictionDf, id.vars = "Time")
Predicted_DF$type<-"Predicted"

Predicted_vs_Observed<-rbind(Internal_DF,Predicted_DF)

Predicted_vs_Observed$variable<-as.character(Predicted_vs_Observed$variable)

Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Ambient.Temperature"] <- "Ambient Temperature"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice"] <- "Tray with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"


#RMSE and Text
dat_text <- data.frame(
label = c("RMSE: 0.50", "RMSE: 0.58", "RMSE:0.63", "RMSE: 0.20", "RMSE: 0.27", "RMSE: 0.48"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,17),
  y     = c(4.5, 2.4, 2.9,3,3.8,12.5)
)

dat_text_h <- data.frame(
label = c("h: 3.10", "h: 0.50", "h: 1.56", "h: 1.44", "h: 2.83", "h = 3.88"  ),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 43, 40,40,40, 12.5),
  y     = c(6, 2.75, 3.75,3.9,5.1, 14)
)

dat_text_bias <- data.frame(
label = c("Bias: 0.49", "Bias: -0.56", "Bias: 0.49", "Bias: 0.18", "Bias: 0.24", "Bias = -0.47"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,17),
  y     = c(3, 2, 2,2.1,2.5,11)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_h$variable<-factor(dat_text_h$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_bias$variable<-factor(dat_text_bias$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

Predicted_vs_Observed$variable<-factor(Predicted_vs_Observed$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

ggplot(Predicted_vs_Observed, aes(x = Time))+
  #geom_point(aes(y = value, color = type))+
  geom_line(aes(y = value, color = type, linetype = type), size=1)+
  facet_wrap(~variable,scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = "Observed vs Predicted",linetype = "Observed vs Predicted", title = "Testing Data")+
  geom_text(data    = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
    geom_text(data    = dat_text_h,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#00AFBB", "#FC4E07")) +
  geom_text(data = dat_text_bias,
  mapping = aes(x = x, y = y, label = label), size =3.5) +
  theme(legend.position="bottom")

ggsave("Figures/Testing Set Plot.jpg", width =8, height = 5, units = "in", dpi = 300)
```





#Repetition 1 Data - This is one out of 3 data sets we used to calculate the negative slopes - When using it, make sure to put the correct negative slope value at the beginning 
```{r}
Condition_Data<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep1Data.csv")
Condition_Data_InternalMilk<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep1Data.csv")

Predicted_RTB<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk$Refrigeration[1], h_condition = h_ref)


calc_rmse(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])

calc_bias(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])


PredictionDf<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB,
                         "Cooler.with.Ice" = Predicted_CI,
                         "Tray.with.Ice"= Predicted_TI,
                         "Tray.with.Ice.Packs"= Predicted_TIP,
                         "Refrigerated.Tray" = Predicted_RT,
                         "Refrigeration" = Predicted_ref)


Internal_DF<-reshape2::melt(Condition_Data_InternalMilk, id.vars = "Time")
Internal_DF$type<-"Observed"

Predicted_DF<-reshape2::melt(PredictionDf, id.vars = "Time")
Predicted_DF$type<-"Predicted"

Predicted_vs_Observed<-rbind(Internal_DF,Predicted_DF)

Predicted_vs_Observed$variable<-as.character(Predicted_vs_Observed$variable)

Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Ambient.Temperature"] <- "Ambient Temperature"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice"] <- "Tray with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"


#RMSE and Text
dat_text <- data.frame(
label = c("RMSE: 0.25", "RMSE: 0.30", "RMSE:0.27", "RMSE: 0.12", "RMSE: 0.38", "RMSE: 0.11"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,17),
  y     = c(4.5, 2.4, 2.9,3,3.8,12.5)
)

dat_text_h <- data.frame(
label = c("h: 3.14", "h: 0.59", "h: 1.71", "h: 1.67", "h: 2.87", "h = 3.86"  ),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 43, 40,40,40, 12.5),
  y     = c(6, 2.75, 3.75,3.9,5.1, 14)
)

dat_text_bias <- data.frame(
label = c("Bias: -0.25", "Bias: -0.19", "Bias:-0.25", "Bias: -0.11", "Bias: -0.35", "Bias: 0.06"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,15),
  y     = c(3, 2, 2,2.1,2.5,11)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_h$variable<-factor(dat_text_h$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_bias$variable<-factor(dat_text_bias$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

Predicted_vs_Observed$variable<-factor(Predicted_vs_Observed$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

ggplot(Predicted_vs_Observed, aes(x = Time))+
  #geom_point(aes(y = value, color = type))+
  geom_line(aes(y = value, color = type, linetype = type), size=1)+
  facet_wrap(~variable,scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = "Observed vs Predicted",linetype = "Observed vs Predicted", title = "Training Data - Repetition 1")+
  geom_text(data    = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
    geom_text(data    = dat_text_h,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#00AFBB", "#FC4E07")) +
  geom_text(data = dat_text_bias,
  mapping = aes(x = x, y = y, label = label), size =3.5) +
  theme(legend.position="bottom")

ggsave("Figures/Training Set Rep1 Plot.jpg", width =8, height = 5, units = "in", dpi = 300)
```




#Repetition 2 Data - This is one out of 3 data sets we used to calculate the negative slopes- When using it, make sure to put the correct negative slope value at the beginning 
```{r}
Condition_Data<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep2Data.csv")

Condition_Data_InternalMilk<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep2Data.csv")

Predicted_RTB<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk$Refrigeration[1], h_condition = h_ref)


calc_rmse(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])

calc_bias(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])


PredictionDf<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB,
                         "Cooler.with.Ice" = Predicted_CI,
                         "Tray.with.Ice"= Predicted_TI,
                         "Tray.with.Ice.Packs"= Predicted_TIP,
                         "Refrigerated.Tray" = Predicted_RT,
                         "Refrigeration" = Predicted_ref)


Internal_DF<-reshape2::melt(Condition_Data_InternalMilk, id.vars = "Time")
Internal_DF$type<-"Observed"

Predicted_DF<-reshape2::melt(PredictionDf, id.vars = "Time")
Predicted_DF$type<-"Predicted"

Predicted_vs_Observed<-rbind(Internal_DF,Predicted_DF)

Predicted_vs_Observed$variable<-as.character(Predicted_vs_Observed$variable)

Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Ambient.Temperature"] <- "Ambient Temperature"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice"] <- "Tray with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"


#RMSE and Text
dat_text <- data.frame(
label = c("RMSE: 0.29", "RMSE: 0.25", "RMSE:0.33", "RMSE: 0.20", "RMSE: 0.50", "RMSE: 0.23"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,17),
  y     = c(4.5, 2.4, 3,3,3.8,12.5)
)

dat_text_h <- data.frame(
label = c("h: 3.21", "h: 0.58", "h: 1.59", "h: 1.54", "h: 2.90", "h = 4.26"  ),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 43, 40,40,40, 12.5),
  y     = c(6, 2.75, 3.85,3.9,5.1, 14)
)

dat_text_bias <- data.frame(
label = c("Bias: -0.28", "Bias: -0.20", "Bias:-0.30", "Bias: -0.19", "Bias: -0.47", "Bias: -0.20"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,15.5),
  y     = c(3, 2, 2.2,2.1,2.5,11)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_h$variable<-factor(dat_text_h$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_bias$variable<-factor(dat_text_bias$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

Predicted_vs_Observed$variable<-factor(Predicted_vs_Observed$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

ggplot(Predicted_vs_Observed, aes(x = Time))+
  #geom_point(aes(y = value, color = type))+
  geom_line(aes(y = value, color = type, linetype = type), size=1)+
  facet_wrap(~variable,scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = "Observed vs Predicted",linetype = "Observed vs Predicted", title = "Training Data - Repetition 2")+
  geom_text(data    = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
    geom_text(data    = dat_text_h,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#00AFBB", "#FC4E07")) +
  geom_text(data = dat_text_bias,
  mapping = aes(x = x, y = y, label = label), size =3.5) +
  theme(legend.position="bottom")

ggsave("Figures/Training Set Rep2 Plot.jpg", width =8, height = 5, units = "in", dpi = 300)
```

#Repetition 3 Data - This is one out of 3 data sets we used to calculate the negative slopes- When using it, make sure to put the correct negative slope value at the beginning 
```{r}
Condition_Data<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep3Data .csv")
Condition_Data_InternalMilk<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep3Data.csv")

Predicted_RTB<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk$Refrigeration[1], h_condition = h_ref)


calc_rmse(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])

calc_bias(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])


PredictionDf<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB,
                         "Cooler.with.Ice" = Predicted_CI,
                         "Tray.with.Ice"= Predicted_TI,
                         "Tray.with.Ice.Packs"= Predicted_TIP,
                         "Refrigerated.Tray" = Predicted_RT,
                         "Refrigeration" = Predicted_ref)


Internal_DF<-reshape2::melt(Condition_Data_InternalMilk, id.vars = "Time")
Internal_DF$type<-"Observed"

Predicted_DF<-reshape2::melt(PredictionDf, id.vars = "Time")
Predicted_DF$type<-"Predicted"

Predicted_vs_Observed<-rbind(Internal_DF,Predicted_DF)

Predicted_vs_Observed$variable<-as.character(Predicted_vs_Observed$variable)

Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Ambient.Temperature"] <- "Ambient Temperature"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice"] <- "Tray with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"


#RMSE and Text
dat_text <- data.frame(
label = c("RMSE: 0.23", "RMSE: 0.26", "RMSE:0.21", "RMSE: 0.12", "RMSE: 0.71", "RMSE: 0.24"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,17),
  y     = c(4.5, 1.8, 2.9,3,3.8,12.5)
)

dat_text_h <- data.frame(
label = c("h: 2.95", "h: 0.34", "h: 1.39", "h: 1.11", "h: 2.73", "h = 3.52"  ),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 43, 40,40,40, 12.5),
  y     = c(6, 2.1, 3.75,3.9,5.1, 14)
)

dat_text_bias <- data.frame(
label = c("Bias: -0.23", "Bias: -0.15", "Bias:-0.19", "Bias: 0.06", "Bias: -0.69", "Bias: 0.22"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(40, 40, 40,40,40,15),
  y     = c(3, 1.5, 2,2.1,2.5,11)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_h$variable<-factor(dat_text_h$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_bias$variable<-factor(dat_text_bias$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

Predicted_vs_Observed$variable<-factor(Predicted_vs_Observed$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

ggplot(Predicted_vs_Observed, aes(x = Time))+
  #geom_point(aes(y = value, color = type))+
  geom_line(aes(y = value, color = type, linetype = type), size=1)+
  facet_wrap(~variable,scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = "Observed vs Predicted",linetype = "Observed vs Predicted", title = "Training Data - Repetition 3")+
  geom_text(data    = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
    geom_text(data    = dat_text_h,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#00AFBB", "#FC4E07")) +
  geom_text(data = dat_text_bias,
  mapping = aes(x = x, y = y, label = label), size =3.5) +
  theme(legend.position="bottom")

ggsave("Figures/Training Set Rep3 Plot.jpg", width =8, height = 5, units = "in", dpi = 300)
```


##For half time in condition the testing set (Deelete if no needed***)
```{r}
Condition_Data<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_TestingData.csv")
Condition_Data_InternalMilk<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_TestingData.csv")

Predicted_RTB<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk$Refrigeration[1], h_condition = h_ref)


calc_rmse(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB)
calc_rmse(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT)
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI)
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP)
calc_rmse(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI)
calc_rmse(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref)

calc_bias(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB)
calc_bias(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT)
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI)
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP)
calc_bias(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI)
calc_bias(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref)


PredictionDf<-data.frame("Time" = c(1:30),
                         "Ambient.Temperature" = Predicted_RTB,
                         "Cooler.with.Ice" = Predicted_CI,
                         "Tray.with.Ice"= Predicted_TI,
                         "Tray.with.Ice.Packs"= Predicted_TIP,
                         "Refrigerated.Tray" = Predicted_RT,
                         "Refrigeration" = Predicted_ref)

library(reshape2)
library(ggplot2)
Internal_DF<-reshape2::melt(Condition_Data_InternalMilk, id.vars = "Time")
Internal_DF$type<-"Observed"

Predicted_DF<-reshape2::melt(PredictionDf, id.vars = "Time")
Predicted_DF$type<-"Predicted"

Predicted_vs_Observed<-rbind(Internal_DF,Predicted_DF)

Predicted_vs_Observed$variable<-as.character(Predicted_vs_Observed$variable)


Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Ambient.Temperature"] <- "Ambient Temperature"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice"] <- "Tray with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"



#RMSE and Text
dat_text <- data.frame(
label = c("RMSE: 0.43", "RMSE: 0.06", "RMSE:1.15", "RMSE: 0.64", "RMSE: 0.41", "RMSE: 1.25"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(20,20,20,20,20,10),
  y     = c(3, 2.55, 3,2.5,2.5,18)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

Predicted_vs_Observed$variable<-factor(Predicted_vs_Observed$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))


ggplot(Predicted_vs_Observed, aes(x = Time))+
  geom_line(aes(y = value, color = type, linetype = type), size=1)+
  facet_wrap(~variable, scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = "Observed vs Predicted",linetype = "Observed vs Predicted", title = "Testing Data, 30 minutes")+
  geom_text(data    = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#00AFBB", "#FC4E07"))

ggsave("Figures/Testing Set.jpg", width =8, height = 5, units = "in", dpi = 300)

```

```{r}
### Version 2 (Ben) ; testing data with h (one trial)
Condition_Data<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep4Data.csv")
Condition_Data_InternalMilk<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep4Data.csv")

Predicted_RTB<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk$Refrigeration[1], h_condition = h_ref)


calc_rmse(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_rmse(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])

calc_bias(actual = Condition_Data_InternalMilk$Ambient.Temperature, predicted = Predicted_RTB[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigerated.Tray, predicted = Predicted_RT[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice, predicted = Predicted_TI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Tray.with.Ice.Packs, predicted = Predicted_TIP[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Cooler.with.Ice, predicted = Predicted_CI[1:60])
calc_bias(actual = Condition_Data_InternalMilk$Refrigeration, predicted = Predicted_ref[1:60])


PredictionDf<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB,
                         "Cooler.with.Ice" = Predicted_CI,
                         "Tray.with.Ice"= Predicted_TI,
                         "Tray.with.Ice.Packs"= Predicted_TIP,
                         "Refrigerated.Tray" = Predicted_RT,
                         "Refrigeration" = Predicted_ref)


Internal_DF<-reshape2::melt(Condition_Data_InternalMilk, id.vars = "Time")
Internal_DF$type<-"Observed"

Predicted_DF<-reshape2::melt(PredictionDf, id.vars = "Time")
Predicted_DF$type<-"Predicted"

Predicted_vs_Observed<-rbind(Internal_DF,Predicted_DF)

Predicted_vs_Observed$variable<-as.character(Predicted_vs_Observed$variable)

Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Ambient.Temperature"] <- "Ambient Temperature"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice"] <- "Tray with Ice"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
Predicted_vs_Observed$variable[Predicted_vs_Observed$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"


#RMSE and Text
### Make automatic values here instead of manual input??
dat_text_h <- data.frame(
label = c(sprintf("h: %.2f", h_RT), sprintf("h: %.2f", h_CI), sprintf("h: %.2f", h_TIC), sprintf("h: %.2f", h_TIP), sprintf("h: %.2f", h_RT), sprintf("h: %.2f", h_ref)),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(17, 17, 17, 17, 17, 15),
  y     = c(17, 17, 17, 17, 17, 10)
)

dat_text <- data.frame(
label = c("RMSE test: 0.50", "RMSE test: 0.58", "RMSE test:0.63", "RMSE test: 0.20", "RMSE test: 0.27", "RMSE test: 0.48"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(17, 17, 17, 17, 17, 15),
  y     = c(15, 15, 15, 15, 15, 8)
)

dat_text_bias <- data.frame(
label = c("Bias test: 0.49", "Bias test: -0.56", "Bias test: 0.49", "Bias test: 0.18", "Bias test: 0.24", "Bias test: -0.47"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(17, 17, 17, 17, 17, 15),
  y     = c(12.5, 12.5, 12.5, 12.5, 12.5, 5.5)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_h$variable<-factor(dat_text_h$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_bias$variable<-factor(dat_text_bias$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

Predicted_vs_Observed$variable<-factor(Predicted_vs_Observed$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

ggplot(Predicted_vs_Observed, aes(x = Time))+
  #geom_point(aes(y = value, color = type))+
  geom_line(aes(y = value, color = type, linetype = type), size=1)+
  facet_wrap(~variable,scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = "Observed vs Predicted",linetype = "Observed vs Predicted", title = "Testing Data")+
  coord_cartesian(ylim = c(0, 25))+
  geom_text(data    = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
    #geom_text(data    = dat_text_h,
  #mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#1111AA","#FFAA00")) +
  geom_text(data = dat_text_bias,
  mapping = aes(x = x, y = y, label = label), size =3.5) +
  theme(legend.position="bottom")
  

ggsave("Figures/Testing Set Plot Ben.jpg", width = 8, height = 5, units = "in", dpi = 300)
```

###multi-graph layout
```{r}
##Repetion 1
Condition_Data_Trial1<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep1Data.csv")
Condition_Data_InternalMilk_Trial1<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep1Data.csv")

Predicted_RTB1<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk_Trial1$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT1<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk_Trial1$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI1<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk_Trial1$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP1<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk_Trial1$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI1<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk_Trial1$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref1<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk_Trial1$Refrigeration[1], h_condition = h_ref)

PredictionDf1<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB1,
                         "Cooler.with.Ice" = Predicted_CI1,
                         "Tray.with.Ice"= Predicted_TI1,
                         "Tray.with.Ice.Packs"= Predicted_TIP1,
                         "Refrigerated.Tray" = Predicted_RT1,
                         "Refrigeration" = Predicted_ref1)
##Repetion 2
Condition_Data_Trial2<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep2Data.csv")

Condition_Data_InternalMilk_Trial2<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep2Data.csv")

Predicted_RTB2<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk_Trial2$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT2<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk_Trial2$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI2<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk_Trial2$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP2<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk_Trial2$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI2<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk_Trial2$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref2<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk_Trial2$Refrigeration[1], h_condition = h_ref)

PredictionDf2<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB2,
                         "Cooler.with.Ice" = Predicted_CI2,
                         "Tray.with.Ice"= Predicted_TI2,
                         "Tray.with.Ice.Packs"= Predicted_TIP2,
                         "Refrigerated.Tray" = Predicted_RT2,
                         "Refrigeration" = Predicted_ref2)
##Repetion 3
Condition_Data_Trial3<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_External_Rep3Data.csv")

Condition_Data_InternalMilk_Trial3<-read.csv("Bevier Trail Data/Bevier_Trial_Temps_Internal_Rep3Data.csv")

Predicted_RTB3<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Ambient.Temperature, Initial_Temp = Condition_Data_InternalMilk_Trial3$Ambient.Temperature[1], h_condition = h_RTB)

Predicted_RT3<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigerated.Tray, Initial_Temp = Condition_Data_InternalMilk_Trial3$Refrigerated.Tray[1], h_condition = h_RT)

Predicted_TI3<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice, Initial_Temp = Condition_Data_InternalMilk_Trial3$Tray.with.Ice[1], h_condition = h_TIC)

Predicted_TIP3<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Tray.with.Ice.Packs, Initial_Temp = Condition_Data_InternalMilk_Trial3$Tray.with.Ice.Packs[1], h_condition = h_TIP)

Predicted_CI3<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Cooler.with.Ice, Initial_Temp = Condition_Data_InternalMilk_Trial3$Cooler.with.Ice[1], h_condition = h_CI)

Predicted_ref3<-predict_temp_fromProf(Time_Temp_Prof =Condition_Data$Refrigeration, Initial_Temp = Condition_Data_InternalMilk_Trial3$Refrigeration[1], h_condition = h_ref)

PredictionDf3<-data.frame("Time" = c(1:60),
                         "Ambient.Temperature" = Predicted_RTB3,
                         "Cooler.with.Ice" = Predicted_CI3,
                         "Tray.with.Ice"= Predicted_TI3,
                         "Tray.with.Ice.Packs"= Predicted_TIP3,
                         "Refrigerated.Tray" = Predicted_RT3,
                         "Refrigeration" = Predicted_ref3)



#Trial 1
Internal_DF_Trial1 <- reshape2::melt(Condition_Data_InternalMilk_Trial1, id.vars = "Time")
Internal_DF_Trial1$type <- "Repetition 1 Observed"

Predicted_DF_Trial1 <- reshape2::melt(PredictionDf1, id.vars = "Time")
Predicted_DF_Trial1$type <- "Repetition 1 Predicted"

#Trial 2
Internal_DF_Trial2 <- reshape2::melt(Condition_Data_InternalMilk_Trial2, id.vars = "Time")
Internal_DF_Trial2$type <- "Repetition 2 Observed"

Predicted_DF_Trial2 <- reshape2::melt(PredictionDf2, id.vars = "Time")
Predicted_DF_Trial2$type <- "Repetition 2 Predicted"

#Trial 3
Internal_DF_Trial3 <- reshape2::melt(Condition_Data_InternalMilk_Trial3, id.vars = "Time")
Internal_DF_Trial3$type <- "Repetition 3 Observed"

Predicted_DF_Trial3 <- reshape2::melt(PredictionDf3, id.vars = "Time")
Predicted_DF_Trial3$type <- "Repetition 3 Predicted"

##Combining
All_Trials_Data <- rbind(Internal_DF_Trial1, Predicted_DF_Trial1,
                         Internal_DF_Trial2, Predicted_DF_Trial2,
                         Internal_DF_Trial3, Predicted_DF_Trial3)

All_Trials_Data$variable <- as.character(All_Trials_Data$variable)
All_Trials_Data$variable[All_Trials_Data$variable == "Ambient.Temperature"] <- "Ambient Temperature"
All_Trials_Data$variable[All_Trials_Data$variable == "Cooler.with.Ice"] <- "Cooler with Ice"
All_Trials_Data$variable[All_Trials_Data$variable == "Tray.with.Ice"] <- "Tray with Ice"
All_Trials_Data$variable[All_Trials_Data$variable == "Tray.with.Ice.Packs"] <- "Tray with Ice Packs"
All_Trials_Data$variable[All_Trials_Data$variable == "Refrigerated.Tray"] <- "Refrigerated Tray"
All_Trials_Data$type <- factor(All_Trials_Data$type, levels = c("Repetition 1 Observed", "Repetition 1 Predicted", "Repetition 2 Observed","Repetition 2 Predicted" , "Repetition 3 Observed", "Repetition 3 Predicted"))
All_Trials_Data$variable <- factor(All_Trials_Data$variable, levels = c("Ambient Temperature", "Cooler with Ice", "Tray with Ice", "Tray with Ice Packs", "Refrigerated Tray", "Refrigeration"))

#RMSE and Text
### Make automatic values here instead of manual input??
dat_text_h <- data.frame(
label = c(sprintf("Avg. h: 3.09"), sprintf("Avg. h: %.2f", h_CI), sprintf("Avg. h: %.2f", h_TIC), sprintf("Avg. h: %.2f", h_TIP), sprintf("Avg. h: %.2f", h_RT), sprintf("Avg. h: %.2f", h_ref)),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(18, 18, 18, 18, 18, 16),
  y     = c(18, 18, 18, 18, 18, 11)
)

dat_text <- data.frame(
label = c("Avg. RMSE: 0.26", "Avg. RMSE: 0.53", "Avg. RMSE:0.27", "Avg. RMSE: 0.15", "Avg. RMSE: 0.27", "Avg. RMSE: 0.19"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(18, 18, 18, 18, 18, 16),
  y     = c(15, 15, 15, 15, 15, 8)
)

dat_text_bias <- data.frame(
label = c("Avg. Bias: -0.25", "Avg. Bias: -0.35", "Avg. Bias: -0.25", "Avg. Bias: -0.11", "Avg. Bias: -0.19", "Avg. Bias: -0.06"),
 variable   = c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"),
  x     = c(17, 17, 17, 17, 17, 15),
  y     = c(12, 12, 12, 12, 12, 5)
)

dat_text$variable<-factor(dat_text$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_h$variable<-factor(dat_text_h$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))

dat_text_bias$variable<-factor(dat_text_bias$variable, levels= c("Ambient Temperature","Cooler with Ice","Tray with Ice","Tray with Ice Packs","Refrigerated Tray","Refrigeration"))


ggplot(All_Trials_Data, aes(x = Time))+
  #geom_point(aes(y = value, color = type))+
  geom_line(aes(y = value, color = type, linetype = type), linewidth=0.7)+
  facet_wrap(~variable,scales = "free_y")+
  theme_bw()+
  labs(y = "Temperature (°C)", x = "Time (min)", color = " ",linetype = " ", title = "Training Data: Repetitions 1-3")+
  geom_text(data = dat_text,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  coord_cartesian(ylim = c(0, 25))+
  geom_text(data    = dat_text_h,
  mapping = aes(x = x, y = y, label = label), size =3.5)+
  scale_color_manual(values = c("#0000AA", "#11ACFF", "#AA0000", "#FF0A11", "#00AA00", "#33FF33")) +
  scale_linetype_manual(values = c("Repetition 1 Observed" = "solid","Repetition 2 Observed" = "solid","Repetition 3 Observed" = "solid", "Repetition 1 Predicted" = "dashed", "Repetition 2 Predicted" = "dashed", "Repetition 3 Predicted" = "dashed")) +  
  geom_text(data = dat_text_bias, mapping = aes(x = x, y = y, label = label), size = 3.5) +
  theme(legend.position="bottom")  

ggsave("Figures/Testing Set Plot Ben multi.jpg", width = 8, height = 5, units = "in", dpi = 300)
```


```


#### Extra #####

```{r}
Actual_Temps<-read.csv("Validation Milk Temps.csv")

Simulated_RT<-Time_Temp_Creation_Var(Total_Time = 125, Interval = 1, Mean_Temperature = 22.1, SD_Temperature = 0.77)
Simulated_Ref<-Time_Temp_Creation_Var(Total_Time = 300, Interval = 1, Mean_Temperature = 3.71, SD_Temperature = 1.04)


Simulated_M_1<-predict_temp_fromProf(Time_Temp_Prof = Simulated_RT$tempM, Initial_Temp = 4.2, h_condition = h_RTB)
Simulated_M_2<-predict_temp_fromProf(Time_Temp_Prof = Simulated_Ref$tempM, Initial_Temp = 17.98, h_condition = h_ref)

Full_df<-data.frame("Simulated Temps" = c(Simulated_M_1,Simulated_M_2),
                    "Actual Temps" = Actual_Temps,
                    "Time" = c(1:427))

Full_df_melted<-melt(Full_df, id.vars = "Time")

ggplot(aes(x = Time, y= value, color= variable ), data = Full_df_melted)+
  geom_point()

predict_temp(Initial_Temp = 4.5,Room_temp = 25, Total_min = 600, h_condition = h_RTB)
plot(predict_temp(Initial_Temp = 18,Room_temp = 8, Total_min = 600, h_condition = h_ref))


```


